# ACE 配置指南

## 概述

ACE（Agentic Coding Environment）是 Codex CLI 的智能学习框架，通过分析您的编码会话来提供上下文感知的建议。

## 配置文件位置

ACE 使用**独立的配置文件**：

```
~/.codeACE/codeACE-config.toml
```

**注意**：此文件与主配置文件 `~/.codeACE/config.toml` 分离，便于独立管理 ACE 功能。

## 自动初始化

首次启动 Codex 时（如果编译时启用了 `ace` feature），ACE 会自动创建默认配置文件。您无需手动创建。

## 默认配置

自动生成的默认配置内容如下：

```toml
# ACE (Agentic Coding Environment) Configuration
#
# This file is automatically generated on first run.
# ACE learns from your coding sessions and provides intelligent context suggestions.

# ============================================================================
# Core Settings
# ============================================================================

[ace]
# Enable or disable ACE framework
enabled = true

# Storage path for learned knowledge (supports ~)
storage_path = "~/.codeACE/ace"

# Maximum number of entries before auto-archiving
max_entries = 500

# ============================================================================
# Reflector Settings (Knowledge Extraction)
# ============================================================================

[ace.reflector]
# Extract code patterns (e.g., file operations, build workflows)
extract_patterns = true

# Extract tool usage information
extract_tools = true

# Extract error handling strategies
extract_errors = true

# ============================================================================
# Context Settings (Knowledge Retrieval)
# ============================================================================

[ace.context]
# Maximum number of recent entries to consider
max_recent_entries = 10

# Include all successful cases in context search
include_all_successes = true

# Maximum characters for context injection
max_context_chars = 4000
```

## 配置说明

### 核心设置 (`[ace]`)

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | `true` | 是否启用 ACE 框架 |
| `storage_path` | string | `"~/.codeACE/ace"` | 存储学习数据的路径（支持 `~`） |
| `max_entries` | integer | `500` | 最大条目数，超过后自动归档 |

### Reflector 设置 (`[ace.reflector]`)

Reflector 负责从对话中提取知识。

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `extract_patterns` | boolean | `true` | 提取代码模式（如文件操作序列、构建流程） |
| `extract_tools` | boolean | `true` | 提取工具使用信息 |
| `extract_errors` | boolean | `true` | 提取错误处理策略 |

### Context 设置 (`[ace.context]`)

Context 控制如何检索和注入历史知识。

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `max_recent_entries` | integer | `10` | 考虑最近 N 条记录 |
| `include_all_successes` | boolean | `true` | 在搜索时包含所有成功案例 |
| `max_context_chars` | integer | `4000` | 注入上下文的最大字符数 |

## 启用/禁用 ACE

### 完全禁用 ACE

编辑 `~/.codeACE/codeACE-config.toml`：

```toml
[ace]
enabled = false
```

### 禁用特定功能

您可以选择性地禁用某些提取功能：

```toml
[ace.reflector]
extract_patterns = false  # 不提取模式
extract_tools = true      # 仍然提取工具使用
extract_errors = true     # 仍然提取错误处理
```

## 调整性能

### 减少内存使用

```toml
[ace]
max_entries = 200  # 减少最大条目数

[ace.context]
max_recent_entries = 5  # 减少考虑的记录数
max_context_chars = 2000  # 减少上下文大小
```

### 增强学习深度

```toml
[ace]
max_entries = 1000  # 保留更多历史

[ace.context]
max_recent_entries = 20  # 考虑更多记录
max_context_chars = 8000  # 注入更多上下文
```

## 数据存储

### 存储位置

默认情况下，ACE 数据存储在：

```
~/.codeACE/ace/
├── playbook.jsonl     # 当前学习数据
└── archive/           # 归档的历史数据
    └── playbook_YYYYMMDD_HHMMSS.jsonl
```

### 自定义存储路径

```toml
[ace]
storage_path = "/custom/path/to/ace-data"
```

### 手动清理数据

如果需要清理所有学习数据（未来将提供 CLI 命令）：

```bash
rm -rf ~/.codeACE/ace/playbook.jsonl
```

## 工作原理

### 学习流程

1. **对话分析**：Reflector 分析您与 Codex 的每次对话
2. **知识提取**：提取有价值的模式、策略和技巧
3. **存储**：将提取的知识存储为结构化的 "bullets"
4. **检索**：下次相关查询时，自动加载相关历史知识
5. **注入**：将上下文注入到对话中，帮助 AI 给出更好的建议

### Bullet-based 架构

ACE 使用基于论文的 Bullet-based 架构，将知识组织为细粒度的条目：

- **Strategies and Rules**：策略和硬性规则
- **Code Snippets and Templates**：可用的代码片段
- **Troubleshooting and Pitfalls**：故障排查和陷阱
- **API Usage Guides**：API 使用指南
- **Error Handling Patterns**：错误处理模式
- **Tool Usage Tips**：工具使用技巧

## 隐私和安全

- ACE 数据**仅存储在本地**（`~/.codeACE/ace/`）
- 不会上传到任何服务器
- 您可以随时删除或禁用 ACE
- 存储格式为可读的 JSONL 文件

## 故障排除

### ACE 未启动

1. 检查是否启用了 `ace` feature（编译时）
2. 检查配置文件 `~/.codeACE/codeACE-config.toml` 中 `enabled = true`
3. 查看日志：
   ```bash
   codex --log-level debug
   ```
   查找包含 "ACE" 的日志消息

### 配置未生效

- ACE 会在 **首次启动时** 创建默认配置
- 如果您修改了配置，需要重启 Codex
- 配置文件路径必须是 `~/.codeACE/codeACE-config.toml`（不是 `config.toml`）

### 性能问题

如果 ACE 影响性能：

1. 减少 `max_recent_entries` 和 `max_context_chars`
2. 降低 `max_entries`，触发更频繁的归档
3. 考虑禁用不需要的提取功能

## 未来功能（开发中）

- `codex ace status` - 查看 ACE 统计信息
- `codex ace show` - 显示最近的学习条目
- `codex ace clear` - 清空 playbook
- `codex ace search <query>` - 搜索历史学习

## 参考

- [ACE 开发计划](/home/com/codeACE/ACE_Development_Master_Plan.md)
- [ACE MVP 实现方案](/home/com/codeACE/req/ACE_Integration_Plan_v6_MVP.md)
- Agentic Context Engineering 论文
